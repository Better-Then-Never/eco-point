import{J as P,m as y,r as w,Z as U,l as W,$ as k,a0 as x,a1 as O,L as v,K as q,a2 as A,a3 as E,n as G,M as L,P as M,q as D,a4 as B,a5 as C,a6 as F}from"#entry";const _=P("firebase",()=>{const f=y(),c=f.$firebaseAuth,u=f.$firebaseDb,r=w(null),t=w(!1),a=w(null);c&&U(c,e=>{r.value=e});const I=W(()=>!!r.value),i=()=>{const e=y().$firebaseAuth??c;if(!e)throw new Error("auth-not-ready");return e};return{user:r,isLoggedIn:I,loading:t,error:a,signIn:async(e,s)=>{t.value=!0,a.value=null;try{const n=await k(i(),e,s);return r.value=n.user,n}catch(n){throw a.value="login-failed",n}finally{t.value=!1}},signInWithGoogle:async()=>{t.value=!0,a.value=null;try{const e=new x,s=await O(i(),e);r.value=s.user;const n=v(u,"users",s.user.uid);if(!(await q(n)).exists()){const l={name:s.user.displayName||"User",username:s.user.email?.split("@")[0]||"user"+Date.now(),email:s.user.email||"",achievements:[],rewards:[],currentMonthSessions:0,pointsBalance:500,pointsEarned:500,totalSessions:0,createdAt:A()};await E(n,l)}return s}catch(e){throw a.value="google-login-failed",e}finally{t.value=!1}},signUp:async e=>{const{name:s,username:n,email:d,password:l,confirmPassword:h,defaultAchievementId:p}=e;t.value=!0,a.value=null;const m=n.trim().toLowerCase().replace(/^@/,"");if(h!==void 0&&l!==h)throw t.value=!1,a.value="passwords-do-not-match",new Error("passwords-do-not-match");if(!/^[a-z0-9._-]{3,30}$/.test(m))throw t.value=!1,a.value="invalid-username",new Error("invalid-username");const b=G(u,"users"),g=L(b,M("username","==",m));let o=null;try{if(!(await D(g)).empty)throw a.value="username-taken",new Error("username-taken");if(o=await B(i(),d,l),r.value=o.user,!(await D(g)).empty){try{await C(o.user)}catch($){console.warn("Failed to delete auth user after username conflict:",$)}throw r.value=null,a.value="username-taken",new Error("username-taken")}const S={name:s.trim(),username:m,email:d.trim(),achievements:p?[v(u,"achievements",p)]:[],rewards:[],currentMonthSessions:0,pointsBalance:500,pointsEarned:500,totalSessions:0,createdAt:A()};return await E(v(u,"users",o.user.uid),S),o}finally{t.value=!1}},signOut:async()=>{await F(i()),r.value=null}}});export{_ as u};
